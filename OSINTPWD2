import argparse
import subprocess
from dotenv import load_dotenv
import os
import requests

# Load environment variables
load_dotenv()

def run_sherlock(query, sites=None):
    """
    Run Sherlock command to search for the given username on social media platforms.
    """
    command = ["python3", "sherlock.py", query]
    if sites:
        command.extend(["--site", ",".join(sites)])

    try:
        result = subprocess.run(command, capture_output=True, text=True, check=True)
        return result.stdout
    except subprocess.CalledProcessError as e:
        return e.stdout

def find_emails_from_usernames(usernames, sites=None):
    """
    Find emails associated with the given usernames using Sherlock.
    """
    emails = []
    for username in usernames:
        result = run_sherlock(username, sites)
        if "No accounts found" not in result:
            emails.extend(result.split('\n')[1:-1])  # Skip the first and last empty lines

    return list(set(emails))  # Remove duplicates

def check_pwned(email):
    """
    Check if the given email has been pwned using the Have I Been Pwned API.
    """
    url = f"https://haveibeenpwned.com/api/v3/breachedaccount/{email}"
    headers = {
        "hibp-api-key": os.getenv("HIBP_API_KEY")
    }
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        return response.json()
    return None

def search_breach_directory(email):
    """
    Search for the given email using the Breach Directory API.
    """
    url = "https://breachdirectory.p.rapidapi.com/"
    querystring = {"func": "auto", "term": email}
    headers = {
        "X-RapidAPI-Key": os.getenv("BREACH_DIRECTORY_API_KEY"),
        "X-RapidAPI-Host": "breachdirectory.p.rapidapi.com"
    }
    response = requests.get(url, headers=headers, params=querystring)
    if response.status_code == 200:
        return response.json()
    return None

def display_pwned_info(email, pwned):
    """
    Display information about pwned status for the given email.
    """
    if pwned and "Breaches" in pwned:
        print(f"Email address {email} has been pwned in the following breaches (Have I Been Pwned):")
        for breach in pwned["Breaches"]:
            print(f"- {breach['Name']} (pwned count: {breach['PwnedCount']})")
    else:
        print(f"Email address {email} not found in Have I Been Pwned.")

def display_breach_directory_info(email, breach_data):
    """
    Display information about breaches from Breach Directory for the given email.
    """
    if breach_data and "breaches" in breach_data:
        print(f"Email address {email} found in the following breaches in Breach Directory:")
        for breach in breach_data["breaches"]:
            print(f"- {breach['Title']}")
    else:
        print(f"No breaches found in Breach Directory for {email}.")

def main():
    # Parse command-line arguments
    parser = argparse.ArgumentParser(description="Search for usernames, associated emails, and check for breaches.")
    parser.add_argument("query", help="The username to search for.")
    parser.add_argument("-s", "--sites", nargs="+", metavar="site", help="Specify the sites to search. Use 'all' to search all sites.")
    args = parser.parse_args()

    # Run Sherlock command for username search
    sherlock_result = run_sherlock(args.query, args.sites)

    # Extract usernames from Sherlock result
    usernames = [line.split(":")[0].strip() for line in sherlock_result.split('\n')[1:-1]]

    # Find emails associated with the found usernames
    emails = find_emails_from_usernames(usernames, args.sites)

    # Check if the emails have been pwned and use the Breach Directory API
    for email in emails:
        pwned = check_pwned(email)
        display_pwned_info(email, pwned)

        # Use the Breach Directory API
        breach_data = search_breach_directory(email)
        display_breach_directory_info(email, breach_data)

if __name__ == "__main__":
    main()
